<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>üé≤ ‡πÄ‡∏Å‡∏°‡∏ô‡πâ‡∏≥‡πÄ‡∏ï‡πâ‡∏≤‡∏õ‡∏π‡∏õ‡∏•‡∏≤ (Asura's Ransom Edition)</title>

<style>
  /* ******************************************************** */
  /* >>>>>> ‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏•‡πá‡∏≠‡∏Ñ‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠ (‡∏´‡πâ‡∏≤‡∏°‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô) <<<<<<< */
  /* ******************************************************** */
  html, body {
    width: 100vw;
    height: 100vh;
    overflow: hidden; 
    margin: 0;
    padding: 0;
  }
  /* ******************************************************** */
  
  /* CSS ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á‡πÅ‡∏•‡∏∞ Fonts */
  @import url('https://fonts.googleapis.com/css2?family=Prompt:wght@400;700&display=swap');
  body {
    font-family: 'Prompt', sans-serif;
    text-align: center;
    background: linear-gradient(135deg, #a71d31, #3f0d12);
    background-size: 400% 400%;
    animation: gradientBG 15s ease infinite;
    color: #fff;
    padding: 20px;
  }
  @keyframes gradientBG {
    0% { background-position: 0% 50%; }
    50% { background-position: 100% 50%; }
    100% { background-position: 0% 50%; }
  }
  h1 {
    color: gold;
    text-shadow: 0 0 15px rgba(255, 215, 0, 0.8), 0 0 5px rgba(255, 215, 0, 0.5);
    margin-bottom: 20px;
  }
  
  /* CSS ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Modal ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô In-App (NEW) */
  #in-app-warning {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.95); /* ‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á‡∏°‡∏∑‡∏î‡∏™‡∏ô‡∏¥‡∏ó */
    color: white;
    z-index: 9999;
    display: flex;
    justify-content: center;
    align-items: center;
    text-align: center;
    padding: 20px;
    box-sizing: border-box;
  }
  #in-app-warning-content {
    background: #333;
    padding: 30px;
    border-radius: 15px;
    border: 3px solid gold;
    max-width: 400px;
    box-shadow: 0 0 30px rgba(255, 215, 0, 0.5);
  }
  #in-app-warning h3 {
    color: gold;
    margin-top: 0;
  }
  .close-warning-btn {
    background: #FF4136;
    color: white;
    padding: 10px 20px;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    margin-top: 20px;
    font-weight: bold;
  }
  
  /* CSS ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡πà‡∏ß‡∏ô Login/Sign-Up */
  .auth-container {
    background: rgba(0, 0, 0, 0.5);
    padding: 30px;
    border-radius: 15px;
    max-width: 400px;
    margin: 50px auto 0px auto; 
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
  }
  
  /* *** Wrapper for input and eye icon *** */
  .input-wrapper {
      position: relative;
      width: 90%; 
      margin: 10px auto;
      text-align: left;
  }
  
  .auth-container input {
    width: 100%; /* Take full width of wrapper */
    padding: 12px;
    padding-right: 40px; /* Space for the icon */
    margin: 0; /* Remove margin from input, use wrapper margin */
    border-radius: 8px;
    border: none;
    font-size: 16px;
    box-sizing: border-box;
    background-color: #f9f9f9;
    color: #333;
    box-shadow: inset 0 2px 5px rgba(0, 0, 0, 0.2);
  }
  
  /* *** Eye Icon Style *** */
  .toggle-password {
      position: absolute;
      right: 10px;
      top: 50%;
      transform: translateY(-50%);
      cursor: pointer;
      color: #666;
      font-size: 18px;
      user-select: none;
      z-index: 10;
  }
  
  .auth-container button {
    display: block;
    width: 90%;
    margin: 15px auto 5px auto;
    padding: 15px 20px;
    border: none;
    border-radius: 12px;
    font-size: 18px;
    cursor: pointer;
    font-weight: bold;
    transition: all 0.2s ease-out;
    box-shadow: 
      0 10px 20px rgba(0, 0, 0, 0.5), 
      0 5px 10px rgba(0, 0, 0, 0.3),
      inset 0 -5px 10px rgba(0, 0, 0, 0.3);
    text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.3);
    letter-spacing: 0.5px;
    text-align: center;
    text-decoration: none; 
  }
  #auth-button {
      background: linear-gradient(145deg, #FFDC00, #FF851B);
      color: black;
  }
  .toggle-link {
    color: #ffd700;
    cursor: pointer;
    text-decoration: none;
    margin-top: 15px;
    display: block;
    font-size: 14px;
    transition: 0.1s;
  }
  
  /* CSS ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Admin Panel */
  #admin-screen {
      display: none;
      max-width: 800px;
      margin: 20px auto;
      background: rgba(0, 0, 0, 0.6);
      padding: 20px;
      border-radius: 15px;
      max-height: calc(100vh - 40px);
      overflow-y: auto;
  }
  #admin-screen h2 {
      color: #33ff33;
      text-shadow: 0 0 8px rgba(51, 255, 51, 0.5);
  }
  .refresh-btn-admin {
      background-color: #007bff; 
      color: white;
      padding: 10px 15px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: bold;
      transition: 0.2s;
      margin-bottom: 15px;
      width: 100%;
      max-width: 300px;
  }
  .refresh-btn-admin:hover {
      background-color: #0056b3;
  }

  #user-list {
      list-style: none;
      padding: 0;
      text-align: left;
      margin-top: 20px;
  }
  #user-list li {
      background: rgba(255, 255, 255, 0.1);
      padding: 15px;
      margin-bottom: 10px;
      border-radius: 10px;
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      justify-content: space-between;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
  }
  .user-info strong {
      color: #FFDC00; 
      font-size: 1.1em;
      text-shadow: 0 0 5px rgba(255, 215, 0, 0.5);
  }
  .user-info {
      font-weight: bold;
      color: #fff;
      min-width: 150px;
  }
  .user-balance {
      color: #FFDC00;
      margin-right: 20px;
  }
  .admin-controls {
      display: flex;
      gap: 10px;
      align-items: center;
      margin-top: 10px;
  }
  .admin-controls input[type="number"] {
      padding: 8px;
      width: 80px;
      border-radius: 5px;
      border: 1px solid #ccc;
      box-sizing: border-box;
      color: #333;
  }
  .admin-controls button {
      padding: 8px 12px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-weight: bold;
      transition: 0.1s;
  }
  .deposit-btn-admin { background-color: #33ff33; color: black; }
  .withdraw-btn-admin { background-color: #ff4136; color: white; }
  .logout-btn-admin { background-color: #ccc; color: black; margin-top: 20px; width: 100%; max-width: 200px; display: block; margin-left: auto; margin-right: auto; }

  /* CSS ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏Å‡∏° */
  #game-screen { 
    display: none; 
    max-height: 100vh;
    overflow-y: auto;
    padding-top: 20px; 
    padding-bottom: 20px;
  }
  #balance {
    background: rgba(255,255,255,0.2);
    display: inline-block;
    padding: 10px 20px;
    border-radius: 25px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.4);
    font-size: 18px;
    margin-bottom: 30px;
    font-weight: bold;
    color: #f0f0f0;
    display: flex;
    align-items: center;
    justify-content: center;
  }
  #balance button {
    margin-left: 10px; 
    padding: 5px 10px; 
    border: none; 
    border-radius: 5px; 
    cursor: pointer; 
    font-weight: bold; 
    transition: 0.1s;
    box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
  }
  .logout-btn { background: #c30000; color: white; }
  .refresh-btn { background: #007bff; color: white; }
  
  /* NEW: ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏õ‡∏∏‡πà‡∏°‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£ (‡πÄ‡∏ï‡∏¥‡∏°‡πÄ‡∏á‡∏¥‡∏ô/‡∏ñ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô) */
  .service-buttons {
      margin-bottom: 20px;
      margin-top: -10px; 
  }
  .service-btn {
      display: inline-block;
      padding: 12px 25px;
      border-radius: 30px;
      font-size: 18px;
      font-weight: bold;
      text-decoration: none;
      color: white;
      cursor: pointer;
      transition: all 0.2s ease-out;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.4);
      text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5);
      border: 2px solid white;
  }
  .service-line-btn {
      background: linear-gradient(145deg, #00C300, #3CFF3C); 
      color: black;
      border-color: #3CFF3C;
  }
  .service-btn:hover {
      transform: translateY(-2px) scale(1.02);
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.6);
  }
  
  /* Layout ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏î‡∏¥‡∏°‡∏û‡∏±‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î */
  .betting-area {
      max-width: 500px;
      margin: 0 auto 25px auto;
  }
  /* ‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏î‡∏¥‡∏°‡∏û‡∏±‡∏ô‡πÄ‡∏î‡∏µ‡πà‡∏¢‡∏ß (Single Bets) */
  .single-bets {
    display: grid; 
    grid-template-columns: repeat(3, 1fr); 
    gap: 15px;
    margin-bottom: 30px;
  }
  .bet-btn-base {
    width: 100%; 
    padding-top: 100%; 
    position: relative;
    font-size: 45px;
    border-radius: 25px;
    cursor: pointer;
    transition: all 0.2s ease-out;
    color: white;
    font-weight: bold;
    box-shadow: 
      0 12px 25px rgba(0,0,0,0.5), 
      0 6px 12px rgba(0,0,0,0.3),  
      inset 0 -6px 15px rgba(0,0,0,0.4);
    display: flex;
    justify-content: center;
    align-items: center;
    border: none;
    line-height: 0; 
  }
  .bet-btn-base > span {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      line-height: 1;
  }
  .bet-btn-base:hover {
    transform: translateY(-4px) scale(1.03);
  }
  .bet-btn-base.selected {
    transform: translateY(-2px) scale(1.08); 
    box-shadow: 
      0 0 30px #FFD700, 
      0 15px 30px rgba(0,0,0,0.8), 
      inset 0 -6px 15px rgba(255, 215, 0, 0.7); 
    outline: 4px solid gold; 
    outline-offset: -4px;
  }
  /* ‡∏™‡∏µ‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏î‡∏¥‡∏°‡∏û‡∏±‡∏ô‡πÄ‡∏î‡∏µ‡πà‡∏¢‡∏ß */
  .bet-btn-single:nth-child(1){background: linear-gradient(145deg,#0074D9,#7FDBFF);} /* ‡∏ô‡πâ‡∏≥‡πÄ‡∏ï‡πâ‡∏≤ */
  .bet-btn-single:nth-child(2){background: linear-gradient(145deg,#FF4136,#FF851B);} /* ‡∏õ‡∏π */
  .bet-btn-single:nth-child(3){background: linear-gradient(145deg,#2ECC40,#01FF70);} /* ‡∏õ‡∏•‡∏≤ */
  .bet-btn-single:nth-child(4){background: linear-gradient(145deg,#B10DC9,#F012BE);} /* ‡πÄ‡∏™‡∏∑‡∏≠ */
  .bet-btn-single:nth-child(5){background: linear-gradient(145deg,#FFDC00,#FF851B);} /* ‡πÑ‡∏Å‡πà */
  .bet-btn-single:nth-child(6){background: linear-gradient(145deg,#39CCCC,#7FDBFF);} /* ‡∏Å‡∏∏‡πâ‡∏á */
  
  /* ‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏î‡∏¥‡∏°‡∏û‡∏±‡∏ô‡∏£‡∏ß‡∏° (High/Low/Triple) */
  .compound-bets {
      display: flex;
      justify-content: space-between;
      gap: 15px;
      margin-top: 30px;
  }
  .bet-btn-compound {
      flex: 1;
      padding: 15px 10px;
      border-radius: 12px;
      font-size: 16px;
      font-weight: bold;
      color: white;
      text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5);
      min-height: 60px;
      box-shadow: 
        0 8px 15px rgba(0,0,0,0.4), 
        inset 0 -4px 8px rgba(0,0,0,0.3);
      border: none;
      cursor: pointer;
      transition: all 0.2s;
  }
  .bet-btn-compound.selected {
      transform: translateY(-2px) scale(1.05); 
      outline: 4px solid #fff; 
      outline-offset: -4px;
  }
  .bet-high { background: linear-gradient(145deg, #FF69B4, #FFB6C1); } /* High */
  .bet-low { background: linear-gradient(145deg, #1E90FF, #87CEFA); } /* Low */
  .bet-triple-any { background: linear-gradient(145deg, #8B0000, #FF0000); } /* Triple (Any) */

  .bet-control { margin-bottom: 25px; display: flex; flex-wrap: wrap; justify-content: center; align-items: center; gap: 10px; }
  .bet-control label { font-size: 16px; font-weight: bold; }
  
  .bet-input-group {
      display: flex;
      gap: 10px;
      align-items: center;
      justify-content: center;
  }

  #betAmount { width: 120px; padding: 10px; border-radius: 10px; border: 3px solid gold; text-align: center; font-size: 18px; color: black; background-color: #f9f9f9; box-shadow: inset 0 2px 5px rgba(0, 0, 0, 0.2); }
  .bet-btn { padding: 10px 15px; border: none; border-radius: 10px; background: #FFDC00; color: black; cursor: pointer; transition: all 0.1s ease; font-weight: bold; box-shadow: 0 4px 10px rgba(0,0,0,0.3); }
  
  button#roll {
    background: gold;
    color: black;
    padding: 18px 40px;
    border: none;
    border-radius: 20px;
    font-size: 22px;
    cursor: pointer;
    transition: all 0.2s ease-out;
    box-shadow: 
      0 15px 30px rgba(255,215,0,0.6), 
      0 8px 15px rgba(255,215,0,0.4),   
      inset 0 -8px 20px rgba(0,0,0,0.3);
    position: relative;
    font-weight: bold;
    letter-spacing: 1px;
    text-transform: uppercase;
  }
  button#roll:disabled {
      background: #ccc;
      box-shadow: none;
      transform: none;
      cursor: not-allowed;
  }
  .dice { font-size: 60px; margin: 20px 0; text-shadow: 0 0 10px rgba(255,255,255,0.5); }
  .result { margin-top: 15px; font-size: 24px; color: #33ff33; text-shadow: 0 0 15px #33ff33, 0 0 5px #33ff33; font-weight: bold; }
  
  /* Responsive Design */
  @media (max-width: 600px) {
    body { padding: 10px; }
    .single-bets { max-width: none; }
    .bet-btn-base { font-size: 35px; border-radius: 20px; }
    
    .bet-control { 
      flex-direction: column; 
      gap: 8px; 
      align-items: center; 
    }
    .bet-control label {
        width: 100%; 
        text-align: center;
        margin-bottom: 5px;
    }

    .bet-input-group {
        width: 100%;
    }
    
    #betAmount { 
      width: 100px; 
      max-width: 100px;
    }
    .bet-input-group .bet-btn {
        padding: 8px 10px;
        font-size: 14px;
    }

    #user-list li { flex-direction: column; align-items: flex-start; }
    .admin-controls { width: 100%; justify-content: space-between; }
    .admin-controls input[type="number"] { width: 40%; }
    .admin-controls button { flex: 1; }
    
    h1 { margin-top: 5px; margin-bottom: 10px; font-size: 20px; } 
    #balance { margin-bottom: 15px; padding: 8px 15px; } 
    .service-buttons { margin-bottom: 10px; margin-top: -5px; } 
    .service-btn {
        padding: 8px 15px; 
        font-size: 16px;
    }
    .compound-bets {
        display: grid; 
        grid-template-columns: repeat(3, 1fr); 
        gap: 8px; 
        margin-top: 15px; 
    }
    .bet-btn-compound {
        padding: 8px 5px; 
        font-size: 14px; 
        min-height: 50px; 
    }
    button#roll {
        padding: 12px 30px; 
        font-size: 18px;
    }
    .dice { font-size: 50px; margin: 10px 0; } 
    .result { margin-top: 10px; font-size: 20px; }
    .betting-area { margin-bottom: 15px; } 
  }
</style>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
</head>
<body>
    
  <div id="in-app-warning" style="display: none;">
      <div id="in-app-warning-content">
          <h3>üö® ‡∏Ñ‡∏≥‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç: ‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÑ‡∏°‡πà‡πÄ‡∏™‡∏ñ‡∏µ‡∏¢‡∏£ üö®</h3>
          <p>‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏≤‡∏Å‡∏Ñ‡∏∏‡∏ì‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏õ‡∏¥‡∏î‡∏ú‡πà‡∏≤‡∏ô‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå‡∏†‡∏≤‡∏¢‡πÉ‡∏ô‡πÅ‡∏≠‡∏õ (Line/TikTok) ‡∏≠‡∏≤‡∏à‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô‡∏ã‡πâ‡∏≥‡∏ö‡πà‡∏≠‡∏¢‡∏Ñ‡∏£‡∏±‡πâ‡∏á</p>
          <p><strong>‡πÇ‡∏õ‡∏£‡∏î‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏°‡∏à‡∏∏‡∏î‡∏™‡∏≤‡∏°‡∏à‡∏∏‡∏î (...) ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏≠‡∏Ñ‡∏≠‡∏ô‡∏•‡∏π‡∏Å‡∏®‡∏£‡∏ä‡∏µ‡πâ‡∏≠‡∏≠‡∏Å ‚ÜóÔ∏è ‡∏ó‡∏µ‡πà‡∏°‡∏∏‡∏°‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏¥‡∏î‡πÄ‡∏ß‡πá‡∏ö‡πÑ‡∏ã‡∏ï‡πå‡∏ô‡∏µ‡πâ‡πÉ‡∏ô‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå Chrome ‡∏´‡∏£‡∏∑‡∏≠ Safari ‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏á</strong></p>
          <button class="close-warning-btn" onclick="document.getElementById('in-app-warning').style.display = 'none';">‡∏â‡∏±‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏à‡πÅ‡∏•‡πâ‡∏ß (‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡πà‡∏≠)</button>
      </div>
  </div>

  <div id="auth-screen" style="display:none;">
    <h1>‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö / ‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å üéØ</h1>
    
    <form class="auth-container" onsubmit="handleAuth(event); return false;" novalidate>
      <h2 id="auth-title">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</h2>
      
      <div class="input-wrapper">
          <input type="email" id="email" placeholder="‡∏≠‡∏µ‡πÄ‡∏°‡∏• (Email)" required>
      </div>

      <div class="input-wrapper">
          <input type="password" id="password" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô (Password)" required>
          <span class="toggle-password" onclick="togglePasswordVisibility('password', this)">üëÅÔ∏è</span>
      </div>
      
      <div id="signup-fields" style="display:none;">
          <div class="input-wrapper">
              <input type="password" id="confirmPassword" placeholder="‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô" required>
              <span class="toggle-password" onclick="togglePasswordVisibility('confirmPassword', this)">üëÅÔ∏è</span>
          </div>
          <div class="input-wrapper">
              <input type="text" id="gameUsername" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ó‡∏µ‡πà‡∏à‡∏∞‡πÅ‡∏™‡∏î‡∏á‡πÉ‡∏ô‡πÄ‡∏Å‡∏°" required>
          </div>
      </div>

      <button id="auth-button" type="submit">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
      <p id="error-message" style="color: red; margin-top: 10px; font-size: 14px;"></p>
      
      <a class="toggle-link" onclick="toggleAuthMode()">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ö‡∏±‡∏ç‡∏ä‡∏µ? ‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà</a>
    </form>

    <div class="service-buttons" style="margin-top: 30px;">
        <p style="font-size: 14px; margin-bottom: 5px; color: #f0f0f0;">‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö/‡∏•‡∏∑‡∏°‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô</p>
        <button onclick="openLineOAPopup()" class="service-btn service-line-btn" style="padding: 10px 20px; font-size: 16px;">
            üìû ‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô (Line OA)
        </button>
    </div>

  </div>
  
  <div id="admin-screen">
      <h2>üõ†Ô∏è ‡πÅ‡∏ú‡∏á‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö</h2>
      
      <button onclick="renderUserList()" class="refresh-btn-admin">
          üîÑ ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô
      </button>

      <ul id="user-list">
          </ul>
      
      <button onclick="adminLogout()" class="logout-btn-admin">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô</button>
  </div>
  
  <div id="game-screen">
    <h1>üé≤ ‡πÄ‡∏Å‡∏°‡∏ô‡πâ‡∏≥‡πÄ‡∏ï‡πâ‡∏≤‡∏õ‡∏π‡∏õ‡∏•‡∏≤ üé≤</h1>
    
    <div class="service-buttons">
        <button onclick="openLineOAPopup()" class="service-btn service-line-btn">
            üí∏ ‡πÄ‡∏ï‡∏¥‡∏°‡πÄ‡∏á‡∏¥‡∏ô/‡∏ñ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô (Line OA)
        </button>
    </div>
    
    <div id="balance">
        üí∞ <span id="usernameDisplay">‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô:</span> <span id="playerBalance">0</span> ‡∏ö‡∏≤‡∏ó
        <button onclick="forceRefresh()" class="refresh-btn">üîÑ</button>
        <button onclick="logout()" class="logout-btn">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</button>
    </div>

    <div class="betting-area">
        <p>‡πÅ‡∏ó‡∏á‡πÄ‡∏î‡∏µ‡πà‡∏¢‡∏ß (‡∏à‡πà‡∏≤‡∏¢ 1-3 ‡πÄ‡∏ó‡πà‡∏≤):</p>
        <div class="single-bets">
            <button class="bet-btn-base bet-btn-single" data-bet-type="single" data-bet-value="‡∏ô‡πâ‡∏≥‡πÄ‡∏ï‡πâ‡∏≤"><span>üçê</span></button>
            <button class="bet-btn-base bet-btn-single" data-bet-type="single" data-bet-value="‡∏õ‡∏π"><span>ü¶Ä</span></button>
            <button class="bet-btn-base bet-btn-single" data-bet-type="single" data-bet-value="‡∏õ‡∏•‡∏≤"><span>üêü</span></button>
            <button class="bet-btn-base bet-btn-single" data-bet-type="single" data-bet-value="‡πÄ‡∏™‡∏∑‡∏≠"><span>üêØ</span></button>
            <button class="bet-btn-base bet-btn-single" data-bet-type="single" data-bet-value="‡πÑ‡∏Å‡πà"><span>üêî</span></button>
            <button class="bet-btn-base bet-btn-single" data-bet-type="single" data-bet-value="‡∏Å‡∏∏‡πâ‡∏á"><span>ü¶ê</span></button>
        </div>

        <p>‡πÅ‡∏ó‡∏á‡∏£‡∏ß‡∏° (‡∏™‡∏π‡∏á/‡∏ï‡πà‡∏≥, ‡∏ï‡∏≠‡∏á):</p>
        <div class="compound-bets">
            <button class="bet-btn-compound bet-high" data-bet-type="high_low" data-bet-value="High">
                ‡∏™‡∏π‡∏á (11-17)<br>‡∏à‡πà‡∏≤‡∏¢ 1:1
            </button>
            <button class="bet-btn-compound bet-low" data-bet-type="high_low" data-bet-value="Low">
                ‡∏ï‡πà‡∏≥ (4-10)<br>‡∏à‡πà‡∏≤‡∏¢ 1:1
            </button>
            <button class="bet-btn-compound bet-triple-any" data-bet-type="triple_any" data-bet-value="Any">
                ‡∏ï‡∏≠‡∏á (‡∏≠‡∏≠‡∏Å 3 ‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡∏Å‡∏±‡∏ô)<br>‡∏à‡πà‡∏≤‡∏¢ 7:1
            </button>
        </div>
    </div>

    <div class="bet-control">
      <label for="betAmount">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏¥‡∏°‡∏û‡∏±‡∏ô (‡∏ï‡πà‡∏≠‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡∏∑‡∏≠‡∏Å):</label>
      
      <div class="bet-input-group">
          <button class="bet-btn" onclick="setMaxBet()">‡πÄ‡∏î‡∏¥‡∏°‡∏û‡∏±‡∏ô‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î</button>
          <input type="number" id="betAmount" value="10" min="0" max="1000">
      </div>
      
      <div id="totalBetDisplay" style="width: 100%; margin-top: 10px; font-weight: bold; color: #33ff33; font-size: 18px; background: rgba(0,0,0,0.3); padding: 10px; border-radius: 10px;">
          ‡∏¢‡∏≠‡∏î‡πÄ‡∏î‡∏¥‡∏°‡∏û‡∏±‡∏ô‡∏£‡∏ß‡∏°: <span>0</span> ‡∏ö‡∏≤‡∏ó
      </div>
    </div>
    
    <button id="roll">‡∏´‡∏°‡∏∏‡∏ô‡∏•‡∏π‡∏Å‡πÄ‡∏ï‡πã‡∏≤</button>

    <div id="diceArea" class="dice"></div>
    <div id="result" class="result"></div>
  </div>

<audio id="rollSound" src="https://www.soundjay.com/misc/sounds/dice-roll-1.mp3"></audio>
<audio id="winSound" src="https://www.soundjay.com/button/sounds/button-3.mp3"></audio>

<script>
// ===============================================
// üéØüéØüéØ 1. Firebase Configuration (‡πÇ‡∏Ñ‡πâ‡∏î‡∏à‡∏£‡∏¥‡∏á‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì) üéØüéØüéØ
// ===============================================
const firebaseConfig = {
    apiKey: "AIzaSyACTSU6LYObSv5gEAfKJt4Yr4LaCCAkQvw",
    authDomain: "goldorax-game.firebaseapp.com",
    databaseURL: "https://goldorax-game-default-rtdb.asia-southeast1.firebasedatabase.app", 
    projectId: "goldorax-game",
    storageBucket: "goldorax-game.firebasestorage.app",
    messagingSenderId: "601999451419",
    appId: "1:601999451419:web:f0782a8437b493eb8f5fbe",
    measurementId: "G-09PW99QK06" 
};

const HOO_HEY_HOW_COLLECTION = "hoo_hey_how_players"; 

// ===============================================
// 2. Initialize Firebase ‡πÅ‡∏•‡∏∞ Global Variables
// ===============================================
firebase.initializeApp(firebaseConfig);

const auth = firebase.auth();
const db = firebase.firestore(); 

const ADMIN_EMAIL = 'admin@gmail.com'; 
const ADMIN_PASS = 'Asura@Ransom4570!'; // ‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡πÉ‡∏´‡∏°‡πà

let isLoginMode = true;
const balanceDisplay = document.getElementById('playerBalance');
const betInput = document.getElementById('betAmount'); 
let balance = 0;
let currentEmail = null; 
let currentDisplayName = null; 

const minBet = 10;
const maxBetDefault = 1000;

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏õ‡∏¥‡∏î/‡∏õ‡∏¥‡∏î‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô
function togglePasswordVisibility(inputId, iconElement) {
    const input = document.getElementById(inputId);
    if (input.type === 'password') {
        input.type = 'text';
        iconElement.textContent = 'üôà'; // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÑ‡∏≠‡∏Ñ‡∏≠‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡∏õ‡∏¥‡∏î‡∏ï‡∏≤ (‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÉ‡∏´‡πâ‡∏ã‡πà‡∏≠‡∏ô)
    } else {
        input.type = 'password';
        iconElement.textContent = 'üëÅÔ∏è'; // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÑ‡∏≠‡∏Ñ‡∏≠‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏õ‡∏¥‡∏î‡∏ï‡∏≤ (‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÉ‡∏´‡πâ‡πÅ‡∏™‡∏î‡∏á)
    }
}

function toggleAuthMode() {
    isLoginMode = !isLoginMode;
    document.getElementById('auth-title').textContent = isLoginMode ? '‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö' : '‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å';
    document.getElementById('auth-button').textContent = isLoginMode ? '‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö' : '‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å';
    document.getElementById('signup-fields').style.display = isLoginMode ? 'none' : 'block';
    document.getElementById('error-message').textContent = '';
    document.querySelector('.toggle-link').textContent = isLoginMode 
        ? '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ö‡∏±‡∏ç‡∏ä‡∏µ? ‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà' 
        : '‡∏°‡∏µ‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß? ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà';
        
    // ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏Ñ‡πà‡∏≤‡πÉ‡∏ô Input ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏™‡∏•‡∏±‡∏ö‡πÇ‡∏´‡∏°‡∏î
    document.getElementById('email').value = ''; 
    document.getElementById('password').value = '';
    if (document.getElementById('confirmPassword')) {
         document.getElementById('confirmPassword').value = '';
    }
    if (document.getElementById('gameUsername')) {
         document.getElementById('gameUsername').value = '';
    }
    
    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÅ‡∏•‡∏∞‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡πÑ‡∏≠‡∏Ñ‡∏≠‡∏ô‡πÄ‡∏õ‡∏¥‡∏î/‡∏õ‡∏¥‡∏î‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô
    const passIcon = document.querySelector('#password + .toggle-password');
    if (passIcon) {
        document.getElementById('password').type = 'password';
        passIcon.textContent = 'üëÅÔ∏è';
    }
    const confirmPassIcon = document.querySelector('#confirmPassword + .toggle-password');
    if (confirmPassIcon) {
        document.getElementById('confirmPassword').type = 'password';
        confirmPassIcon.textContent = 'üëÅÔ∏è';
    }
}

// ===============================================
// 3. User Authentication (‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ Submit ‡πÅ‡∏•‡∏∞ Error)
// ===============================================
async function handleAuth(event) {
    // *** ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå ***
    if (event) {
        event.preventDefault(); 
    }

    const email = document.getElementById('email').value.trim();
    const password = document.getElementById('password').value;
    const errorMessage = document.getElementById('error-message');
    errorMessage.textContent = ''; 
    
    // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î
    const authButton = document.getElementById('auth-button');
    authButton.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£...';
    authButton.disabled = true;

    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    if (!emailRegex.test(email)) {
        errorMessage.textContent = '‚ùå ‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á (‡∏´‡πâ‡∏≤‡∏°‡∏°‡∏µ‡∏ä‡πà‡∏≠‡∏á‡∏ß‡πà‡∏≤‡∏á‡∏ô‡∏≥‡∏´‡∏ô‡πâ‡∏≤/‡∏ï‡∏≤‡∏°‡∏´‡∏•‡∏±‡∏á)';
    }
    
    if (!email || !password) {
        errorMessage.textContent = '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡πÅ‡∏•‡∏∞‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô';
    }
    
    if (errorMessage.textContent !== '') {
        authButton.textContent = isLoginMode ? '‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö' : '‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å';
        authButton.disabled = false;
        return;
    }
    
    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö Admin Login (Hardcoded)
    if (email === ADMIN_EMAIL && password === ADMIN_PASS) {
        adminLoginSuccess();
        return;
    }

    try {
        await auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL);

        if (isLoginMode) {
            // *** ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô ‡πÅ‡∏•‡∏∞‡πÄ‡∏£‡∏µ‡∏¢‡∏Å checkAuthStateAndRoute() ‡πÅ‡∏ó‡∏ô reload ***
            await auth.signInWithEmailAndPassword(email, password);
            
            // ‡∏•‡πâ‡∏≤‡∏á‡∏ä‡πà‡∏≠‡∏á‡∏Å‡∏£‡∏≠‡∏Å‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à
            document.getElementById('email').value = '';
            document.getElementById('password').value = '';
            
            checkAuthStateAndRoute(); 
        } else {
            // SIGN UP Logic (with 12-char password check)
            const confirmPassword = document.getElementById('confirmPassword').value;
            const gameUsername = document.getElementById('gameUsername').value.trim();
            
            if (!gameUsername || gameUsername.length < 3 || gameUsername.length > 20) {
                 errorMessage.textContent = '‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÉ‡∏ô‡πÄ‡∏Å‡∏°‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ 3-20 ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£';
            }
            
            if (password.length < 12) { 
                errorMessage.textContent = '‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏≤‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 12 ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£'; 
            }

            if (password !== confirmPassword) {
                errorMessage.textContent = '‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÅ‡∏•‡∏∞‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ô';
            }
            
            if (errorMessage.textContent !== '') {
                 authButton.textContent = '‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å';
                 authButton.disabled = false;
                 return;
            }

            const existingUsernames = await db.collection(HOO_HEY_HOW_COLLECTION).where('displayName', '==', gameUsername).get();
            if (!existingUsernames.empty) {
                errorMessage.textContent = '‚ùå ‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ô‡∏µ‡πâ‡∏°‡∏µ‡∏Ñ‡∏ô‡πÉ‡∏ä‡πâ‡πÅ‡∏™‡∏î‡∏á‡πÉ‡∏ô‡πÄ‡∏Å‡∏°‡πÅ‡∏•‡πâ‡∏ß! ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏≠‡∏∑‡πà‡∏ô';
                authButton.textContent = '‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å';
                authButton.disabled = false;
                return;
            }
            
            const userCredential = await auth.createUserWithEmailAndPassword(email, password);
            const user = userCredential.user;

            await db.collection(HOO_HEY_HOW_COLLECTION).doc(email).set({
                email: email, 
                displayName: gameUsername, 
                balance: 0,
                uid: user.uid 
            });
            
            alert('‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á'); 
            toggleAuthMode();
        }
        
    } catch (error) {
        // *** ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡∏û‡∏¥‡∏°‡∏û‡πå error ‡πÄ‡∏ï‡πá‡∏°‡πÉ‡∏ô Console ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Debug ***
        console.error("Firebase Auth Error Details:", error); 
        
        let displayError = '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô';

        if (error.code === 'auth/user-not-found' || error.code === 'auth/wrong-password' || error.code === 'auth/invalid-credential') {
            displayError = '‚ùå ‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏´‡∏£‡∏∑‡∏≠‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á';
        } else if (error.code === 'auth/email-already-in-use') {
            displayError = '‚ùå ‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏ô‡∏µ‡πâ‡∏°‡∏µ‡∏Ñ‡∏ô‡πÉ‡∏ä‡πâ‡πÅ‡∏•‡πâ‡∏ß! ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö ‡∏´‡∏£‡∏∑‡∏≠‡πÉ‡∏ä‡πâ‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏≠‡∏∑‡πà‡∏ô';
        } else if (error.code === 'auth/weak-password') {
            displayError = '‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡∏≠‡πà‡∏≠‡∏ô‡πÅ‡∏≠‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ (‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 12 ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£)';
        } else if (error.code === 'auth/operation-not-allowed') {
            displayError = '‚ö†Ô∏è ‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡∏≤‡∏£‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏ñ‡∏π‡∏Å‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô! ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÅ‡∏à‡πâ‡∏á‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô "Email/Password" ‡πÉ‡∏ô Firebase Console';
        } else if (error.code === 'auth/invalid-email') {
             displayError = '‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á';
        } else {
            displayError = `‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ${error.message}`; 
        }
        
        errorMessage.textContent = displayError;
        
    } finally {
        // ‡∏Ñ‡∏∑‡∏ô‡∏Ñ‡πà‡∏≤‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏™‡∏°‡∏≠
        authButton.textContent = isLoginMode ? '‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö' : '‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å';
        authButton.disabled = false;
    }
}

// ===============================================
// 4. Game Logic Handlers
// ===============================================

function openLineOAPopup() {
    const lineOALink = 'https://lin.ee/Mm1caQx';
    const width = 600; 
    const height = 800; 
    
    const left = (screen.width / 2) - (width / 2);
    const top = (screen.height / 2) - (height / 2);

    window.open(
        lineOALink, 
        '_blank', 
        `width=${width},height=${height},top=${top},left=${left},scrollbars=yes,resizable=yes`
    );
}

async function loginSuccess(email, uid) {
    currentEmail = email;
    
    document.getElementById('auth-screen').style.display = 'none';
    document.getElementById('admin-screen').style.display = 'none';
    document.getElementById('game-screen').style.display = 'block';
    
    history.pushState({ screen: 'game' }, '', window.location.pathname);
    
    const userRef = db.collection(HOO_HEY_HOW_COLLECTION).doc(email);

    userRef.onSnapshot(doc => {
        if (doc.exists) {
            currentDisplayName = doc.data().displayName || email; 
            balance = doc.data().balance; 
        } else {
            balance = 0; 
            currentDisplayName = email;
        }
        
        document.getElementById('usernameDisplay').textContent = `‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô ${currentDisplayName}:`; 
        balanceDisplay.textContent = balance;
        updateBetControls(); 
        updateTotalCostDisplay(); 

        console.log(`‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô ${currentDisplayName} ‡∏ñ‡∏π‡∏Å‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÄ‡∏õ‡πá‡∏ô ${balance} ‡∏ö‡∏≤‡∏ó (Real-time)`);
        
    }, err => {
        console.error("Error listening to user balance:", err);
        document.getElementById('result').textContent = '‚ö†Ô∏è ‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡πÑ‡∏î‡πâ‡πÅ‡∏ö‡∏ö Real-time';
    });
}

function forceRefresh() {
    document.getElementById('result').textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡πÇ‡∏´‡∏•‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡πÉ‡∏´‡∏°‡πà)...';
    setTimeout(() => {
        window.location.reload(); 
    }, 500); 
}

function updateBetControls() {
    let defaultBet = Math.min(balance > 0 ? 10 : 0, balance);
    betInput.value = defaultBet;
    betInput.min = balance > 0 ? minBet : 0;
    betInput.max = Math.min(balance, maxBetDefault);

    const rollButton = document.getElementById('roll');
    if (balance === 0) {
        rollButton.disabled = true;
        rollButton.textContent = '‚ö†Ô∏è ‡πÄ‡∏ï‡∏¥‡∏°‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏•‡πà‡∏ô';
    } else {
        rollButton.disabled = false;
        rollButton.textContent = '‡∏´‡∏°‡∏∏‡∏ô‡∏•‡∏π‡∏Å‡πÄ‡∏ï‡πã‡∏≤';
    }
}

function logout() {
    auth.signOut();
    window.location.reload(); 
}


// ===============================================
// 5. Admin Panel Logic 
// ===============================================
function adminLoginSuccess() {
    document.getElementById('auth-screen').style.display = 'none';
    document.getElementById('game-screen').style.display = 'none';
    document.getElementById('admin-screen').style.display = 'block';
    history.pushState({ screen: 'admin' }, '', window.location.pathname);
    renderUserList(); 
}

function adminLogout() {
    window.location.reload(); 
}

async function renderUserList() {
    const userListElement = document.getElementById('user-list');
    userListElement.innerHTML = '';
    
    try {
        const snapshot = await db.collection(HOO_HEY_HOW_COLLECTION).get();
        
        let userCount = 0;
        snapshot.forEach(doc => {
            const email = doc.id; 
            const user = doc.data();
            const displayName = user.displayName || email; 
            
            const listItem = document.createElement('li');
            listItem.innerHTML = `
                <span class="user-info">‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Å‡∏°: <strong>${displayName}</strong></span> 
                <span class="user-info">‡∏≠‡∏µ‡πÄ‡∏°‡∏•: <strong>${email}</strong></span> 
                <span class="user-balance">‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô: ${user.balance} ‡∏ö‡∏≤‡∏ó</span>
                <div class="admin-controls">
                    <input type="number" id="amount-${email.replace(/[^a-zA-Z0-9]/g, '_')}" placeholder="‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô">
                    <button class="deposit-btn-admin" onclick="updateUserBalance('${email}')">+ ‡πÄ‡∏ï‡∏¥‡∏°‡πÄ‡∏á‡∏¥‡∏ô</button>
                    <button class="withdraw-btn-admin" onclick="updateUserBalance('${email}', false)">- ‡∏ñ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô</button>
                </div>
            `;
            userListElement.appendChild(listItem);
            userCount++;
        });

        if (userCount === 0) {
            userListElement.innerHTML = '<li>‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö</li>';
        }

    } catch (error) {
        userListElement.innerHTML = `<li>‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•: ${error.message}</li>`;
        console.error("Error loading user list:", error);
    }
}

async function updateUserBalance(email, isDeposit = true) {
    const safeId = email.replace(/[^a-zA-Z0-9]/g, '_');
    const amountInput = document.getElementById(`amount-${safeId}`);
    const amount = parseInt(amountInput.value);

    if (isNaN(amount) || amount <= 0) {
        alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á!');
        return;
    }
    
    const userRef = db.collection(HOO_HEY_HOW_COLLECTION).doc(email);

    try {
        await db.runTransaction(async (transaction) => {
            const doc = await transaction.get(userRef);
            if (!doc.exists) {
                throw "‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô";
            }
            
            let currentBalance = doc.data().balance;
            let newBalance;
            const displayName = doc.data().displayName || email;

            if (isDeposit) {
                newBalance = currentBalance + amount;
            } else {
                if (currentBalance < amount) {
                    throw "‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡πÑ‡∏°‡πà‡∏û‡∏≠";
                }
                newBalance = currentBalance - amount;
            }
            
            transaction.update(userRef, { balance: newBalance });
            
            if (isDeposit) {
                alert(`‡πÄ‡∏ï‡∏¥‡∏°‡πÄ‡∏á‡∏¥‡∏ô‡πÉ‡∏´‡πâ ${displayName}: ${amount} ‡∏ö‡∏≤‡∏ó ‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡πÉ‡∏´‡∏°‡πà‡∏Ñ‡∏∑‡∏≠ ${newBalance} ‡∏ö‡∏≤‡∏ó`);
            } else {
                alert(`‡∏ñ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏à‡∏≤‡∏Å ${displayName}: ${amount} ‡∏ö‡∏≤‡∏ó ‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡πÉ‡∏´‡∏°‡πà‡∏Ñ‡∏∑‡∏≠ ${newBalance} ‡∏ö‡∏≤‡∏ó`);
            }
        });

        renderUserList();
        amountInput.value = ''; 

    } catch (error) {
        if (error === "‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡πÑ‡∏°‡πà‡∏û‡∏≠") {
            alert(`‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡πÑ‡∏°‡πà‡πÄ‡∏û‡∏µ‡∏¢‡∏á‡∏û‡∏≠‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏ñ‡∏≠‡∏ô ${amount} ‡∏ö‡∏≤‡∏ó`);
        } else {
            alert(`‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ${error}`);
            console.error("Transaction failed: ", error);
        }
    }
}

async function getUserBalance(email) {
    const doc = await db.collection(HOO_HEY_HOW_COLLECTION).doc(email).get();
    return doc.exists ? doc.data().balance : 0;
}


// ===============================================
// 6. Game Logic Handlers
// ===============================================

const animals = ['‡∏ô‡πâ‡∏≥‡πÄ‡∏ï‡πâ‡∏≤','‡∏õ‡∏π','‡∏õ‡∏•‡∏≤','‡πÄ‡∏™‡∏∑‡∏≠','‡πÑ‡∏Å‡πà','‡∏Å‡∏∏‡πâ‡∏á'];
const emojis = ['üçê','ü¶Ä','üêü','üêØ','üêî','ü¶ê'];
const animalValues = { '‡∏ô‡πâ‡∏≥‡πÄ‡∏ï‡πâ‡∏≤': 1, '‡∏õ‡∏π': 2, '‡∏õ‡∏•‡∏≤': 3, '‡πÄ‡∏™‡∏∑‡∏≠': 4, '‡πÑ‡∏Å‡πà': 5, '‡∏Å‡∏∏‡πâ‡∏á': 6 };

const activeBets = new Map(); 

const diceArea = document.getElementById('diceArea');
const result = document.getElementById('result');
const rollSound = document.getElementById('rollSound');
const winSound = document.getElementById('winSound');


function updateTotalCostDisplay() {
    const amountPerBet = parseInt(betInput.value) || 0;
    const totalCost = amountPerBet * activeBets.size;
    document.querySelector('#totalBetDisplay span').textContent = totalCost.toLocaleString();
    
    const rollButton = document.getElementById('roll');
    if (totalCost > balance && balance > 0) {
        rollButton.disabled = true;
        rollButton.textContent = '‚ùå ‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏¥‡∏°‡∏û‡∏±‡∏ô‡∏£‡∏ß‡∏°‡πÄ‡∏Å‡∏¥‡∏ô‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô!';
    } else if (balance > 0) {
        rollButton.disabled = false;
        rollButton.textContent = '‡∏´‡∏°‡∏∏‡∏ô‡∏•‡∏π‡∏Å‡πÄ‡∏ï‡πã‡∏≤';
    }
}

function setMaxBet() {
    let max = Math.min(balance, maxBetDefault);
    betInput.value = max;
    updateTotalCostDisplay(); 
}

betInput.addEventListener('input', updateTotalCostDisplay); 

const bettingButtons = document.querySelectorAll('[data-bet-type]');
bettingButtons.forEach(btn => {
    btn.addEventListener('click', () => {
        const type = btn.dataset.betType;
        const value = btn.dataset.betValue;
        const key = `${type}-${value}`;

        if (activeBets.has(key)) {
            activeBets.delete(key);
            btn.classList.remove('selected');
        } else {
            if (type !== 'single' && (activeBets.has('high_low-High') || activeBets.has('high_low-Low') || activeBets.has('triple_any-Any'))) {
                let conflictingKey = Array.from(activeBets.keys()).find(k => k.startsWith('high_low') || k.startsWith('triple_any'));
                if (conflictingKey) {
                    activeBets.get(conflictingKey).classList.remove('selected');
                    activeBets.delete(conflictingKey);
                }
            }
            
            activeBets.set(key, btn);
            btn.classList.add('selected');
        }
        
        updateTotalCostDisplay(); 
    });
});


// ===============================================
// 7. ‡πÇ‡∏Ñ‡πâ‡∏î Roll Dice ‡∏û‡∏£‡πâ‡∏≠‡∏° Transaction 
// ===============================================

document.getElementById('roll').addEventListener('click', async () => {
    const currentBetAmount = parseInt(betInput.value); 

    if (activeBets.size === 0) { alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏î‡∏¥‡∏°‡∏û‡∏±‡∏ô‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏≠‡∏¢‡πà‡∏≤‡∏á!'); return; }
    
    const totalBetCost = currentBetAmount * activeBets.size;
    
    if (totalBetCost > balance) { 
        alert(`‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡πÑ‡∏°‡πà‡πÄ‡∏û‡∏µ‡∏¢‡∏á‡∏û‡∏≠‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏î‡∏¥‡∏°‡∏û‡∏±‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ${totalBetCost} ‡∏ö‡∏≤‡∏ó!`); 
        updateBetControls(); 
        updateTotalCostDisplay();
        return; 
    }

    // ************ ‡∏Å‡∏≤‡∏£‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏° UI ‡∏Å‡πà‡∏≠‡∏ô Transaction ************
    balance -= totalBetCost;
    balanceDisplay.textContent = balance;
    diceArea.textContent = '‡∏´‡∏°‡∏∏‡∏ô...';
    result.textContent = '';
    rollSound.currentTime = 0;
    rollSound.play();
    document.getElementById('roll').disabled = true; 

    try {
        // ************ 1. ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏´‡∏±‡∏Å‡∏•‡∏á‡πÉ‡∏ô Firestore ‡∏î‡πâ‡∏ß‡∏¢ Transaction ************
        await db.runTransaction(async (transaction) => {
            const userRef = db.collection(HOO_HEY_HOW_COLLECTION).doc(currentEmail); 
            const userDoc = await transaction.get(userRef);

            if (!userDoc.exists) {
                throw new Error("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•");
            }
            
            let dbBalance = userDoc.data().balance;
            let newDbBalance = dbBalance - totalBetCost;

            if (newDbBalance < 0) {
                throw new Error("‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡πÉ‡∏ô‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏û‡∏≠ (Race Condition)");
            }

            transaction.update(userRef, { balance: newDbBalance });
            balance = newDbBalance;
        });

        // ************ 2. ‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏´‡∏°‡∏∏‡∏ô‡∏•‡∏π‡∏Å‡πÄ‡∏ï‡πã‡∏≤‡πÅ‡∏•‡∏∞‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏ú‡∏• (‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°) ************
        setTimeout(async () => { 
            const diceResults = []; 
            const diceValues = []; 
            for (let i = 0; i < 3; i++) {
                const randomIndex = Math.floor(Math.random() * animals.length);
                const animalName = animals[randomIndex];
                diceResults.push(animalName);
                diceValues.push(animalValues[animalName]);
            }
            
            diceArea.innerHTML = diceResults.map(name => emojis[animals.indexOf(name)]).join(' ');

            const sum = diceValues.reduce((a, b) => a + b, 0);
            const counts = diceResults.reduce((acc, name) => {
                acc[name] = (acc[name] || 0) + 1;
                return acc;
            }, {});
            
            const isTriple = Object.values(counts).some(count => count === 3);
            const tripleAnimal = isTriple ? diceResults[0] : null;
            const isHigh = sum >= 11 && sum <= 17;
            const isLow = sum >= 4 && sum <= 10;
            
            let totalWinnings = 0;
            let winDetails = [];
            let didWin = false;

            activeBets.forEach((element, key) => {
                const [type, value] = key.split('-');
                let profit = 0;
                let resultMessage = '';

                switch(type) {
                    case 'single':
                        const hitCount = counts[value] || 0;
                        if (hitCount > 0) {
                            profit = currentBetAmount * hitCount; 
                            resultMessage = `‡∏ä‡∏ô‡∏∞ ‡πÅ‡∏ó‡∏á‡πÄ‡∏î‡∏µ‡πà‡∏¢‡∏ß ${value} ‡∏≠‡∏≠‡∏Å ${hitCount} ‡∏ï‡∏±‡∏ß (‡∏Å‡∏≥‡πÑ‡∏£ ${profit} ‡∏ö‡∏≤‡∏ó)`;
                        }
                        break;

                    case 'high_low':
                        const betIsHigh = value === 'High';
                        
                        if (isTriple) {
                            resultMessage = `‡πÅ‡∏û‡πâ ‡∏ï‡∏≠‡∏á‡∏≠‡∏≠‡∏Å (‡∏™‡∏π‡∏á/‡∏ï‡πà‡∏≥ ‡πÅ‡∏û‡πâ‡∏ó‡∏∏‡∏Å‡∏Å‡∏£‡∏ì‡∏µ)`;
                        } else if ((betIsHigh && isHigh) || (!betIsHigh && isLow)) {
                            profit = currentBetAmount * 1;
                            resultMessage = `‡∏ä‡∏ô‡∏∞ ‡πÅ‡∏ó‡∏á ${value} (‡πÅ‡∏ï‡πâ‡∏°‡∏£‡∏ß‡∏° ${sum}) (‡∏Å‡∏≥‡πÑ‡∏£ ${profit} ‡∏ö‡∏≤‡∏ó)`;
                        }
                        break;
                    
                    case 'triple_any':
                        if (isTriple) {
                            profit = currentBetAmount * 7; 
                            resultMessage = `‡∏ä‡∏ô‡∏∞ ‡∏ï‡∏≠‡∏á ${tripleAnimal} (‡∏Å‡∏≥‡πÑ‡∏£ ${profit} ‡∏ö‡∏≤‡∏ó)`;
                        }
                        break;
                }
                
                if (profit > 0) {
                    totalWinnings += profit;
                    didWin = true;
                    winDetails.push(resultMessage);
                } else if (resultMessage) {
                    winDetails.push(resultMessage);
                }
            });
            
            const totalPayout = totalBetCost + totalWinnings; 
            balance += totalWinnings; 
            
            if (didWin) {
                result.textContent = `üéâ ‡∏ä‡∏ô‡∏∞! ‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô‡∏Ñ‡∏∑‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ${totalPayout} ‡∏ö‡∏≤‡∏ó (‡∏Å‡∏≥‡πÑ‡∏£‡∏™‡∏∏‡∏ó‡∏ò‡∏¥ ${totalWinnings} ‡∏ö‡∏≤‡∏ó)\n‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î: ${winDetails.join(' | ')}`;
                winSound.currentTime = 0;
                winSound.play();
            } else {
                result.textContent = `‡πÄ‡∏™‡∏µ‡∏¢‡πÉ‡∏à! ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏î‡∏¥‡∏°‡∏û‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ä‡∏ô‡∏∞ üò¢ (‡πÄ‡∏™‡∏µ‡∏¢ ${totalBetCost} ‡∏ö‡∏≤‡∏ó)`;
            }
            
            activeBets.forEach(element => element.classList.remove('selected'));
            activeBets.clear();
            
            // ************ 3. ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏∏‡∏î‡∏ó‡πâ‡∏≤‡∏¢‡∏•‡∏á‡πÉ‡∏ô Firestore ‡∏î‡πâ‡∏ß‡∏¢ Transaction ************
            await db.runTransaction(async (transaction) => {
                const userRef = db.collection(HOO_HEY_HOW_COLLECTION).doc(currentEmail);
                transaction.update(userRef, { balance: balance });
            });
            
            updateBetControls();
            updateTotalCostDisplay(); 
            document.getElementById('roll').disabled = false; 

        }, 900); 

    } catch (error) {
        alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•! ‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡∏≠‡∏≤‡∏à‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏´‡∏±‡∏Å/‡πÄ‡∏û‡∏¥‡πà‡∏° ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà');
        
        const latestBalance = await getUserBalance(currentEmail); 
        balance = latestBalance; 
        
        balanceDisplay.textContent = balance;
        console.error("Game Roll Transaction Failed: ", error);
        document.getElementById('roll').disabled = false;
        updateBetControls();
        updateTotalCostDisplay(); 
        result.textContent = '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠!';
    }
});


// -----------------------------------------------------
// üéØüéØüéØ 8. ‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡∏ó‡∏±‡∏ô‡∏ó‡∏µ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÇ‡∏´‡∏•‡∏î‡∏´‡∏ô‡πâ‡∏≤ (Auto Login) üéØüéØüéØ
// -----------------------------------------------------

// *** NEW: ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ï‡∏£‡∏ß‡∏à‡∏à‡∏±‡∏ö Line OA/TikTok ***
function detectInAppBrowser() {
    const ua = navigator.userAgent.toLowerCase();
    
    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö Line/TikTok/Facebook
    const isLine = ua.includes('line');
    const isTikTok = ua.includes('tiktok'); 
    const isFacebook = ua.includes('fbav');
    
    return isLine || isTikTok || isFacebook; 
}

// *** NEW: ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÅ‡∏™‡∏î‡∏á‡∏Ñ‡∏≥‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô ***
function showInAppWarning() {
    if (detectInAppBrowser()) {
        document.getElementById('in-app-warning').style.display = 'flex';
    }
}


async function checkAuthStateAndRoute() {
    document.getElementById('auth-screen').style.display = 'none';
    document.getElementById('admin-screen').style.display = 'none';
    document.getElementById('game-screen').style.display = 'none';
    
    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö Admin Login (Hardcoded check)
    const emailInput = document.getElementById('email');
    const passwordInput = document.getElementById('password');
    const adminEmailCheck = emailInput ? emailInput.value.trim() : null;
    const adminPassCheck = passwordInput ? passwordInput.value : null;

    if (adminEmailCheck === ADMIN_EMAIL && adminPassCheck === ADMIN_PASS) {
        adminLoginSuccess();
        return;
    }

    try {
        const user = auth.currentUser; 
        
        if (user) {
            const email = user.email;
            
            if (email === ADMIN_EMAIL) { 
                adminLoginSuccess();
                return;
            }
            loginSuccess(email, user.uid);
            return;
        }

        // ‡∏´‡∏≤‡∏Å‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ó‡∏µ‡πà‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô‡∏≠‡∏¢‡∏π‡πà ‡πÉ‡∏´‡πâ‡πÅ‡∏™‡∏î‡∏á‡∏´‡∏ô‡πâ‡∏≤‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô
        document.getElementById('auth-screen').style.display = 'block';

    } catch (error) {
        console.error("Auth state check failed:", error);
        document.getElementById('auth-screen').style.display = 'block';
    }
}

// ‡πÄ‡∏û‡∏¥‡πà‡∏° Listener ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Back Button ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏£‡πà‡∏ß‡∏°‡∏Å‡∏±‡∏ö history.pushState
window.addEventListener('popstate', (event) => {
    if (event.state && (event.state.screen === 'game' || event.state.screen === 'admin')) {
        // Do nothing 
    } else {
        // Fallback to Auth screen
        checkAuthStateAndRoute();
    }
});

// *** ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: Listener ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö window.focus ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏Å‡πâ‡∏õ‡∏±‡∏ç‡∏´‡∏≤ Line OA Logout ***
window.addEventListener('focus', function() {
    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô‡∏ó‡∏±‡∏ô‡∏ó‡∏µ‡∏ó‡∏µ‡πà‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡πÇ‡∏ü‡∏Å‡∏±‡∏™
    if (auth.currentUser) {
        checkAuthStateAndRoute(); 
    }
});

// *** ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ‡∏ó‡∏±‡πâ‡∏á In-App Warning ‡πÅ‡∏•‡∏∞ Auth Check ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÇ‡∏´‡∏•‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß ***
document.addEventListener('DOMContentLoaded', () => {
    showInAppWarning(); 
    checkAuthStateAndRoute(); 
});

</script>
</body>
</html>
